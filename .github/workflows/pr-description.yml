name: PR Description Generator

on:
  pull_request:
    types: [opened, edited]

permissions:
  pull-requests: write
  contents: read

jobs:
  generate-description:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Prettier
        run: npm install -g prettier

      - name: Check Prettier
        id: prettier-check
        run: |
          if npx prettier --check .; then
            echo "prettier_status=✅ Passed" >> $GITHUB_OUTPUT
          else
            echo "prettier_status=❌ Failed" >> $GITHUB_OUTPUT
          fi

      - name: Get Changed Files
        id: changed-files
        run: |
          {
            echo 'files<<EOF'
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Update PR Description
        uses: actions/github-script@v6
        with:
          script: |
            const changedFiles = `${{ steps.changed-files.outputs.files }}`;
            const prettierStatus = `${{ steps.prettier-check.outputs.prettier_status }}`;

            const { data: currentPR } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            let currentBody = currentPR.body || '';
            const autoGenMarker = '<!-- AUTO-GENERATED-SECTION -->';
            const autoGenEnd = '<!-- AUTO-GENERATED-END -->';

            const autoGenContent = `## Files Changed\n\`\`\`\n${changedFiles}\n\`\`\`\n\n## Code Quality\n**Prettier Check:** ${prettierStatus}\n\n*Auto-generated on ${new Date().toISOString()}*`;

            const autoGenSection = autoGenMarker + '\n' + autoGenContent + '\n' + autoGenEnd;

            let newBody = '';

            if (context.payload.action === 'opened' && !currentBody) {
              const template = '## Project\n' +
                '- [ ] QuickClinic\n' +
                '- [ ] QuickMed\n' +
                '\n' +
                '## Change Type\n' +
                '- [ ] New Feature/Page\n' +
                '- [ ] Bug Fix\n' +
                '- [ ] UI Redesign\n' +
                '- [ ] Optimization\n' +
                '- [ ] Other\n' +
                '\n' +
                '## Page Type\n' +
                '- [ ] Public\n' +
                '- [ ] Patient\n' +
                '- [ ] Doctor\n' +
                '- [ ] Admin\n' +
                '\n' +
                '## Stack\n' +
                '- [ ] Frontend\n' +
                '- [ ] Backend\n' +
                '- [ ] Full Stack\n' +
                '\n' +
                '## Route Status\n' +
                '- [ ] New Route\n' +
                '- [ ] Existing Route\n' +
                '\n' +
                '## What Changed\n' +
                '### Route/API Affected\n' +
                '<!-- Specify the route or API endpoint -->\n' +
                '\n' +
                '### Description\n' +
                '<!-- Detailed description of changes -->\n' +
                '\n' +
                '## Screenshots\n' +
                '### Mobile View\n' +
                '<!-- Add mobile screenshots here -->\n' +
                '\n' +
                '### Desktop View\n' +
                '<!-- Add desktop screenshots here -->\n' +
                '\n' +
                autoGenSection;
              
              newBody = template;
            } else if (currentBody.includes(autoGenMarker)) {
              newBody = currentBody.replace(
                /<!-- AUTO-GENERATED-SECTION -->[\s\S]*?<!-- AUTO-GENERATED-END -->/,
                autoGenSection
              );
            } else if (context.payload.action === 'edited') {
              newBody = currentBody + '\n\n' + autoGenSection;
            } else {
              newBody = currentBody;
            }

            if (newBody !== currentBody) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: newBody
              });
              console.log('✅ PR description updated');
            }
